<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador Financeiro</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to right, #00c6ff, #0072ff);
            color: #333;
            padding: 20px;
            transition: background 0.5s ease;
        }
        
        h1,
        h2 {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .card {
            margin: 10px 0;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: scale(1.02);
        }
        
        .input-group {
            margin-top: 10px;
        }
        
        .btn-primary,
        .btn-success,
        .btn-warning,
        .btn-info,
        .btn-danger {
            transition: background-color 0.3s, transform 0.2s;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .btn-warning:hover {
            background-color: #856404;
            transform: translateY(-2px);
        }
        
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        
        .transaction-row {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.3s;
        }
        
        .transaction-row:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .income {
            color: #28a745;
        }
        
        .expense {
            color: #dc3545;
        }
        
        #chartContainer {
            display: none;
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translate(-50%, -10%);
            z-index: 1000;
            background-color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.5s forwards;
        }
        
        @keyframes slideIn {
            from {
                transform: translate(-50%, -50%) scale(0);
            }
            to {
                transform: translate(-50%, -10%) scale(1);
            }
        }
        
        @media (max-width: 768px) {
            .transaction-row {
                flex-direction: column;
                align-items: flex-start;
            }
            .transaction-row span {
                margin-bottom: 5px;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 class="text-center">Gerenciador Financeiro</h1>

        <!-- Barra de Busca do Google -->
        <div class="card p-4">
            <h2>Busca do Google</h2>
            <form id="googleSearch" target="_blank" action="https://www.google.com/search">
                <div class="input-group">
                    <input type="text" name="q" class="form-control" placeholder="Pesquise no Google..." required>
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="submit">Buscar</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="user-info" class="card p-4">
            <p id="welcome-message"></p>
            <p id="session-time"></p>
        </div>
        <div class="card p-4">
            <h2>Saldo Total: R$ <span id="totalBalance">0.00</span></h2>
            <div>
                <h4>Receitas: R$ <span id="totalIncome">0.00</span></h4>
                <h4>Despesas: R$ <span id="totalExpenses">0.00</span></h4>
            </div>
        </div>

        <div class="admin-actions card p-4">
            <h2>Ações do Administrador</h2>
            <button id="viewReports" class="btn btn-warning">Ver Relatórios</button>
            <button id="generatePDF" class="btn btn-success">Gerar Recibo em PDF</button>
            <button id="showChart" class="btn btn-info">Mostrar Gráfico</button>
        </div>

        <div class="card p-4">
            <h2>Adicionar Transação</h2>
            <form id="transactionForm">
                <div class="form-group">
                    <input type="text" id="description" class="form-control" placeholder="Descrição" required>
                </div>
                <div class="form-group">
                    <input type="number" id="amount" class="form-control" placeholder="Valor" required>
                </div>
                <div class="form-group">
                    <select id="transactionType" class="form-control">
                    <option value="income">Receita</option>
                    <option value="expense">Despesa</option>
                </select>
                </div>
                <button type="submit" class="btn btn-primary">Adicionar</button>
            </form>
        </div>

        <div id="transactions" class="card p-4">
            <h2>Transações</h2>
            <div id="transactionList"></div>
        </div>
    </div>

    <!-- Container for the Chart -->
    <div id="chartContainer">
        <h3>Gráfico de Transações</h3>
        <canvas id="myChart" width="400" height="200"></canvas>
        <button id="closeChart" class="btn btn-danger">Fechar</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <script type="module">
        import { showFinancialReport } from './app.js'; document.getElementById('viewReports').addEventListener('click', showFinancialReport);
    </script>


    <script>
        let totalBalance = 0;
        let totalIncome = 0;
        let totalExpenses = 0;
        const sessionKey = 'sessionTime';
        let sessionStart;
        const adminPassword = "admin123"; // Senha aleatória para admin

        async function initApp() {
            const storedUserName = localStorage.getItem('userName');
            const storedUserType = localStorage.getItem('userType');

            if (storedUserName && storedUserType) {
                loadUserData(storedUserName, storedUserType);
            } else {
                await promptUserInfo();
            }

            await loadTransactions();
            updateSessionTime();
            setInterval(updateSessionTime, 1000);
        }

        async function promptUserInfo() {
            const userName = prompt("Qual é o seu nome?");
            let userType = prompt("Você é um 'admin' ou 'usuário'? (deixe em branco para usuário)");

            if (userType === 'admin') {
                const password = prompt("Digite a senha para administrador:");
                if (password !== adminPassword) {
                    alert("Senha incorreta. Você será registrado como usuário.");
                    userType = "usuário";
                }
            }

            localStorage.setItem('userName', userName);
            localStorage.setItem('userType', userType);

            loadUserData(userName, userType);
        }

        function loadUserData(userName, userType) {
            document.getElementById("welcome-message").innerText = `Olá, ${userName}!`;

            if (userType === 'admin') {
                document.querySelector(".admin-actions").style.display = 'block';
                document.getElementById("welcome-message").innerText += " Você tem permissões de administrador.";
            } else {
                document.getElementById("welcome-message").innerText += " Você tem permissões de usuário.";
            }
        }

        async function loadTransactions() {
            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            transactions.forEach(transaction => {
                addTransactionToDisplay(transaction.description, transaction.amount, transaction.type);
                updateTotals(transaction.type, transaction.amount);
            });
        }

        function addTransactionToDisplay(description, amount, type) {
            const transactionList = document.getElementById('transactionList');
            const transactionRow = document.createElement('div');
            transactionRow.classList.add('transaction-row', type === 'income' ? 'income' : 'expense');

            transactionRow.innerHTML = `
        <span>${description}</span>
        <span>R$ ${amount.toFixed(2)}</span>
    `;

            transactionList.appendChild(transactionRow);
        }

        function updateTotals(type, amount) {
            if (type === 'income') {
                totalBalance += amount;
                totalIncome += amount;
            } else {
                totalBalance -= amount;
                totalExpenses += amount;
            }
            updateDisplayTotals();
        }

        function updateDisplayTotals() {
            document.getElementById('totalBalance').innerText = totalBalance.toFixed(2);
            document.getElementById('totalIncome').innerText = totalIncome.toFixed(2);
            document.getElementById('totalExpenses').innerText = totalExpenses.toFixed(2);

            // Atualiza o localStorage
            localStorage.setItem('totalIncome', totalIncome.toFixed(2));
            localStorage.setItem('totalExpenses', totalExpenses.toFixed(2));
        }

        function updateSessionTime() {
            if (!sessionStart) {
                sessionStart = Date.now();
            }
            const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById("session-time").innerText = `Tempo logado: ${minutes} minutos e ${seconds} segundos`;
        }

        document.getElementById('transactionForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const description = document.getElementById('description').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const transactionType = document.getElementById('transactionType').value;

            // Salvar transação no localStorage
            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            transactions.push({
                description,
                amount,
                type: transactionType
            });
            localStorage.setItem('transactions', JSON.stringify(transactions));

            // Atualiza a exibição e os totais
            addTransactionToDisplay(description, amount, transactionType);
            updateTotals(transactionType, amount);

            // Limpar o formulário
            document.getElementById('transactionForm').reset();
        });

        document.getElementById('viewReports').addEventListener('click', function() {
            showFinancialReport();
        });

        document.getElementById('generatePDF').addEventListener('click', function() {
            const {
                jsPDF
            } = window.jspdf;
            const doc = new jsPDF();

            doc.text("Recibo de Transações", 20, 20);
            doc.text(`Saldo Total: R$ ${totalBalance.toFixed(2)}`, 20, 30);
            doc.text(`Receitas: R$ ${totalIncome.toFixed(2)}`, 20, 40);
            doc.text(`Despesas: R$ ${totalExpenses.toFixed(2)}`, 20, 50);

            doc.save("recibo.pdf");
        });

        document.getElementById('showChart').addEventListener('click', function() {
            generateChart();
            $('#chartContainer').fadeIn();
        });

        document.getElementById('closeChart').addEventListener('click', function() {
            $('#chartContainer').fadeOut();
        });

        function generateChart() {
            const ctx = document.getElementById('myChart').getContext('2d');
            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            const labels = transactions.map(t => t.description);
            const incomeData = transactions.filter(t => t.type === 'income').map(t => t.amount);
            const expenseData = transactions.filter(t => t.type === 'expense').map(t => t.amount);

            const myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Receitas',
                        data: incomeData,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Despesas',
                        data: expenseData,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Função para gerar relatório financeiro
        function generateFinancialReport(userName, totalIncome, totalExpenses) {
            let report = `Relatório Financeiro de ${userName}\n\n`;
            const budgetStatus = totalIncome - totalExpenses;

            if (budgetStatus > 0) {
                report += `Situação: Você está com um saldo positivo de R$ ${budgetStatus.toFixed(2)}.\n`;
                report += "Parabéns! Continue assim e considere investir sua renda extra.";
            } else if (budgetStatus < 0) {
                report += `Situação: Você está com um saldo negativo de R$ ${Math.abs(budgetStatus).toFixed(2)}.\n`;
                report += "É importante revisar suas despesas e buscar formas de cortar gastos.";
            } else {
                report += `Situação: Você está com o orçamento equilibrado.\n`;
                report += "Bom trabalho! Mantenha-se atento às suas receitas e despesas.";
            }

            return report;
        }

        // Função para mostrar o relatório em uma janela de alerta
        function showFinancialReport() {
            const userName = localStorage.getItem('userName');
            const totalIncome = parseFloat(localStorage.getItem('totalIncome')) || 0;
            const totalExpenses = parseFloat(localStorage.getItem('totalExpenses')) || 0;

            const report = generateFinancialReport(userName, totalIncome, totalExpenses);
            alert(report);
        }

        // Inicializa a aplicação
        initApp();
    </script>
</body>

</html>